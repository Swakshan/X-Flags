name: Features - Auto

on:
  repository_dispatch:
    types: [update-event]
 
jobs:
  download-and-extract:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
      CHANNEL_NAME: ${{ secrets.CHANNEL_NAME }}
      PIN_MSG: ${{ secrets.X_PIN_MSG }}
      DEBUG: ${{ secrets.DEBUG }}
      SHARE_TO_TELE: ${{ secrets.SHARE_TO_TELE }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'
   

    - name: Install modules
      run: |
        pip install -r requirements.txt


    - name: Download & Extract
      run: |
        python src/main.py --app ${{ github.event.client_payload.app }} --platform ${{ github.event.client_payload.platform }} --source ${{ github.event.client_payload.source }} --type ${{ github.event.client_payload.type }}  --downLink ${{ github.event.client_payload.downLink }}  --msgId ${{ github.event.client_payload.msgId }} --vername ${{ github.event.client_payload.vername }} ${{ env.DEBUG }}

    - name: Add extracted file to Git
      id: vars
      run: |
        git fetch
        CHANGES=$(git diff --name-only origin/main)
        if [ -n "$CHANGES" ]; then
          echo "Changes found."
          python src/git.py
          echo "PUSH=1" >> $GITHUB_OUTPUT
        else
          echo "No changes found."
          echo "PUSH=0" >> $GITHUB_OUTPUT
        fi

    - name: Commit data
      uses: rlespinasse/git-commit-data-action@v1 
      
    - name: Changes to Telegram
      run: |      
        python src/sendTelegram.py ${{ env.BOT_TOKEN }} ${{ env.CHANNEL_ID }} ${{ env.CHANNEL_NAME }} ${{ env.X_PIN_MSG }} ${{ env.SHARE_TO_TELE }} ${{ env.DEBUG }}